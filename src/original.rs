use ethers::types::U128;

pub const F_4: &str = "FFFFFFFF";
pub const EMPTY_4: &str = "00000000";
pub const EMPTY_32: &str = "0000000000000000000000000000000000000000000000000000000000000000";
pub const MAX_U128: &str = "0000000000000000000000000000000000000000ffffffffffffffffffffffff";
// PUSH20 followed by AND is used to "mask" the 32-byte address into its correct type.
pub const MASK_20: &str = "ffffffffffffffffffffffffffffffffffffffff";

#[derive(Debug, Clone, serde::Serialize)]
pub enum Types {
    Uint,
    Int,
    Bytes,

    Bool,
    Uint8,
    Bytes1,

    Bytes20,
    Address,

    Selector,
    String,

    Address0,
    ZeroUint,

    MaxUint128,
}

/// Converts `calldata` into chunks of `size`.
pub fn chunkify(calldata: &str, size: usize) -> Vec<String> {
    calldata
        .chars()
        .collect::<Vec<char>>()
        .chunks(size)
        .map(|c| c.iter().collect::<String>())
        .collect::<Vec<String>>()
}

/// Adds padding of '0's.
///
/// ## Params
/// 1. chunks - vector of bytes-32 (64 chars).
/// 2. current - the chunks element we're currently on.
/// 3. side - front or back of the calldata (true == left, false = right).
pub fn add_padding(chunks: Vec<String>, current: usize, side: bool) -> Vec<String> {
    // let total = current * 64;
    let mut chunks = chunks.clone();

    match side {
        true => chunks[current] = format!("{}{}", EMPTY_4.to_string(), chunks[current]),
        false => chunks[current] = format!("{}{}", chunks[current], EMPTY_4.to_string()),
    }

    let len = chunks.len() - 1;
    chunks[len] = chunks[len].split_at(56).0.to_string();

    let new = chunkify(&chunks.concat(), 64);
    new
}

/// Attempts to a selector from the bytes-32 (64 &str).
///
/// ## Returns:
/// 1. Function selector.
/// 2. New calldata param.
pub fn try_parse_selector(calldata: &str) -> (String, String) {
    let mut chunks = chunkify(calldata, 8);

    // Replace function selector if exists.
    if chunks[0] != EMPTY_4 && chunks[1] == EMPTY_4 && chunks[0] != F_4 {
        let selector = chunks[0].clone();
        chunks[0] = chunks[0].replace(&chunks[0], "");
        return (selector, chunks.join(""));
    }

    (EMPTY_4.to_string(), chunks.join(""))
}

/// Moves EMPTY_4 to end of calldata.
///
/// ## Params
/// 1. chunks: Vec<String64>.
///
/// ## Returns:
/// 1. New chunks: Vec<String64>.
/// 2. New param for index `from`.
pub fn rearrange_chunks(
    chunks: Vec<String>,
    from: usize,
    replacement: String,
) -> (Vec<String>, String) {
    let mut new_chunks = chunks.clone();
    new_chunks[from] = replacement;

    // TODO...Add selector replacement offset.
    // ...

    let new_calldata = format!("{}{}", new_chunks.concat(), EMPTY_4);
    let new_chunks = chunkify(&new_calldata, 64);

    (new_chunks, new_calldata)
}

/// Returns the raw param before `current`, if available.
///
/// ## Params
/// 1. chunks - vector of bytes-32 (64 chars).
/// 2. current - the chunks element we're currently on.
pub fn last_raw(params: &Vec<String>, current: usize) -> Option<String> {
    if current == 0 {
        return None;
    }
    Some(params[current - 1].clone())
}

/// Returns the raw param after `current`, if available.
///
/// ## Params
/// 1. chunks - vector of bytes-32 (64 chars).
/// 2. current - the chunks element we're currently on.
pub fn next_raw(params: &Vec<String>, current: usize) -> Option<String> {
    let len = params.len() - 1;
    match current >= len {
        true => None,
        false => Some(params[len].clone()),
    }
}

#[derive(Debug, Clone)]
pub enum Types {
    Uint,
    Int,
    Bytes,

    Bool,
    Uint8,
    Bytes1,

    Bytes20,
    Address,

    Selector,
    String,

    Address0,
    ZeroUint,

    MaxUint128,
}

#[derive(Clone)]
pub struct ParamTypes(Vec<Types>);
impl ParamTypes {
    pub fn new(t: Vec<Types>) -> Self {
        Self(t)
    }
}
impl std::fmt::Debug for ParamTypes {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.write_str(&format!("{:?}", self.0))
    }
}

#[derive(Clone)]
pub struct Params {
    pub selector: String,
    pub params: Vec<String>,
    pub types: Vec<ParamTypes>,
}

impl Params {
    pub fn new(selector: &str, params: Vec<String>) -> Self {
        Self {
            selector: selector.to_string(),
            params,
            types: vec![],
        }
    }
}

impl std::fmt::Debug for Params {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.write_str(&format!(
            "Method ID: {}\nInputs: {:#?}\nTypes: {:#?}",
            self.selector, self.params, self.types
        ))
    }
}

#[derive(Clone, Debug)]
pub struct Calldata {
    pub calldata: String,
    pub selector: String,
    raw_params: Vec<String>,
    params: Vec<String>,
    parsed_params: Vec<Params>,
}

impl Calldata {
    pub fn new(calldata: &str) -> Self {
        let mut s = Self {
            calldata: calldata.to_string(),
            selector: String::new(),
            raw_params: vec![],
            params: vec![],
            parsed_params: vec![],
        };
        s.parse_selector();
        s.parse_params();
        s
    }

    /// Parses the initial selector the calldata is being sent to.
    pub fn parse_selector(&mut self) {
        if self.calldata.contains("0x") {
            self.calldata = self.calldata.replace("0x", "");
            // println!("after replace {}", self.calldata);
        }

        // If no remainders with modulo 64...
        if self.calldata.len() % 64 == 0 {
            // Separate calldata into 32-byte chunks.
            self.raw_params = chunkify(&self.calldata, 64);

            // Get function selector from calldata.
            self.selector = self.raw_params[0].split_at(8).0.to_string();

            // Replace it with 0s to just have input.
            self.raw_params[0] = self.raw_params[0].replace(&self.selector, "");
        } else {
            // Separate calldata into 1-byte chunks.
            let mut chunks = chunkify(&self.calldata, 2);

            self.selector = format!("{}{}{}{}", chunks[0], chunks[1], chunks[2], chunks[3]);

            chunks[0] = "".to_string();
            chunks[1] = "".to_string();
            chunks[2] = "".to_string();
            chunks[3] = "".to_string();

            let mut params: Vec<String> = vec![String::new()];

            for chunk in chunks.iter() {
                let mut len = params.len() - 1;

                // Check if we have the param.
                if params[len].len() == 64 {
                    // Add new param.
                    params.push(String::new());
                    // Make sure we're pushing to new param.
                    len += 1;
                }

                params[len].push_str(chunk);
            }

            self.raw_params = params;
        }
    }

    /// Parses the calldata for each param and it's selector.
    pub fn parse_params(&mut self) {
        let mut i = 0;
        let mut params: (Vec<String>, bool) = (self.raw_params.clone(), false);

        let mut skipping = 0;
        let mut offsets: Vec<(usize, U128, bool)> = vec![]; // pc of offset + offset

        loop {
            println!("{} Parsed params: {:#?}", i, params.0);

            let raw_param;
            if skipping != 0 {
                i += skipping;
                skipping = 0;
            }

            if &params.0[i] == EMPTY_32 {
                params.0 = add_padding(params.0, i, true);

                i += 1;
            }

            raw_param = &params.0[i];

            let trimmed = raw_param.trim_start_matches('0').to_string();

            // Check if param has selector in it.
            let parsed = try_parse_selector(&raw_param);

            // If selector found
            if parsed.0 != EMPTY_4 && parsed.0 != F_4 {
                // println!("selector {}", parsed.0);

                // Check if last param was a length type.
                // They usually come before functions/dynamic types - espc in multicalls.
                if let Some(last) = last_raw(&params.0, i) {
                    let last_trimmed = last.trim_start_matches('0').to_string();
                    if let Ok(v) = U128::from_str_radix(&last_trimmed, 16) {
                        // Extract selector + params.
                        if let Some(skip) = self.parse_len(&params.0, i, v.as_usize()) {
                            // println!("selector found");

                            let rearranged = rearrange_chunks(params.0, i, parsed.1);
                            params = (rearranged.0.clone(), true);

                            // How many chars we skip next loop.
                            skipping = skip;
                        }
                    }
                }
            }
            // Offsets/lengths never have selectors
            // Therefore, we check common offset/length sizes.
            else if trimmed.len() <= 4 {
                // Check if value is for dynamic type.
                if let Ok(v) = U128::from_str_radix(&trimmed, 16) {
                    // Check if offset
                    if v < U128::from(i * 64 + 1920) && v % 64 == U128::from(0) {
                        offsets.push((i, v / 64, false));
                    }
                }
            }

            // println!("params: {}/{} - {:#?}", i, self.raw_params.len(), params.0);

            i += 1;

            if i == self.raw_params.len() {
                break;
            }
        }

        self.params = params.0;
        self.parma_types();

        println!("---------- Params ----------");
        println!(
            "Raw calldata:\nMethod ID: {} {:#?}\nIdentified params: {:#?}\nParsed calldata: {:#?}",
            &self.selector, &self.raw_params, &self.parsed_params, &self.params,
        );
    }

    ///
    pub fn parse_len(&mut self, params_64: &Vec<String>, from: usize, len: usize) -> Option<usize> {
        let params = params_64.split_at(from);

        let calldata = params.1.concat();
        let cut = calldata.split_at(len * 2);

        let remainder = (len * 2) % 64;
        // println!("remainder: {}", remainder);
        // println!("len: {}", len);

        // If remainder 8 we know its a function.
        if remainder == 8 {
            let cut = cut.0.split_at(8);
            let new_params = chunkify(cut.1, 64);

            // println!(
            //     "
            //     to cut {}
            //     selector {}
            //     body {:#?}
            //     ",
            //     len, cut.0, new_params,
            // );

            // Record params.
            self.parsed_params.push(Params::new(cut.0, new_params));

            // If extracting only function.
            if len == 4 {
                return None;
            }

            // println!("to skip {}", (len - 8) * 2 / 64);
            return Some((len - 8) * 2 / 64);
        }
        // TODO..FINISH THIS OFF
        // How to cut out strings????

        // If remaidner is 56, probably a string/fn selector.
        else if remainder == 56 {
            //     let cut = cut.0.split_at(8);
            //     let _new_params = chunkify(cut.1, 64);
        }

        None
    }

    /// Attempts to guess the potential types the param could be.
    pub fn parma_types(&mut self) {
        for params in self.parsed_params.iter_mut() {
            let mut types: Vec<ParamTypes> = vec![];

            for param in params.params.iter() {
                if param == EMPTY_32 {
                    types.push(ParamTypes::new(vec![Types::Address0, Types::ZeroUint]));
                    continue;
                } else if param == MAX_U128 {
                    types.push(ParamTypes::new(vec![Types::MaxUint128]));
                    continue;
                }

                let chunks = chunkify(param, 8);
                if chunks[0] != EMPTY_4 && chunks[1] == EMPTY_4 && chunks[0] != F_4 {
                    types.push(ParamTypes::new(vec![
                        Types::Selector,
                        Types::String,
                        Types::Bytes,
                    ]));
                    continue;
                } else if chunks[0] == F_4 {
                    types.push(ParamTypes::new(vec![
                        Types::Int,
                        Types::String,
                        Types::Bytes,
                    ]));
                    continue;
                }

                let trimmed = param.trim_start_matches('0').to_string();
                if trimmed.len() == 40 {
                    types.push(ParamTypes::new(vec![
                        Types::Address,
                        Types::Bytes20,
                        Types::Uint,
                    ]));
                    continue;
                }

                if let Ok(v) = U128::from_str_radix(&param, 16) {
                    if v <= U128::one() {
                        types.push(ParamTypes::new(vec![
                            Types::Bool,
                            Types::Uint8,
                            Types::Bytes1,
                        ]));
                        continue;
                    } else if let Ok(eight) = U128::from_dec_str("8") {
                        if v <= eight {
                            types.push(ParamTypes::new(vec![
                                Types::Bool,
                                Types::Uint8,
                                Types::Bytes1,
                            ]));
                            continue;
                        }
                    }
                }

                types.push(ParamTypes::new(vec![Types::Uint, Types::Int, Types::Bytes]));
            }
            params.types = types;
        }
    }
}

/*
cargo test test_calldata_new -- --nocapture --test-threads=1
*/
#[cfg(test)]
mod test_calldata_new {

    use super::Calldata;

    /*
        0x5d842074 // fn selector
        000000000000000000000000000000000000000000000006c6b935b8bbd40000 // uint256
        0000000000000000000000000000000000000000000000000000000000000040 // offset of array
        0000000000000000000000000000000000000000000000000000000000000002 // len of array
        00000000000000000000000000000000000000000000002086ac351052600000 // [0] uint256 of array
        00000000000000000000000000000000000000000000002b5e3af16b18800000 // [1] uint256 of array
    */
    #[test]
    #[ignore]
    fn test_parse_normal_fn() {
        let calldata = "0x5d842074000000000000000000000000000000000000000000000006c6b935b8bbd400000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000002086ac35105260000000000000000000000000000000000000000000000000002b5e3af16b18800000";
        println!(
            "\nCalldata char len: {}\nBytes: {}",
            calldata.len(),
            calldata.len() / 64 * 32
        );
        let _calldata = Calldata::new(calldata);
    }

    /*
        Convert the calldata [0]'s etherscan decoded to the following [1]:

        Tx: https://etherscan.io/tx/0x1fe71e209bfed2990ac72e88a640b09008be10579ae1405a8c86ce2ced5767d1
        Calldata: 0xac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000016488316456000000000000000000000000c011a73ee8576fb46f5e1c5751ca3b9fe0af2a6f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000002710fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffee530ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1b18000000000000000000000000000000000000000000000000016345785d89fd6800000000000000000000000000000000000000000000000000007f73eca3063a000000000000000000000000000000000000000000000000016042b530ddaec600000000000000000000000000000000000000000000000000007e59f044bada000000000000000000000000f847e9d51989033b691b8be943f8e9e268f99b9e000000000000000000000000000000000000000000000000000000006377347700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000412210e8a00000000000000000000000000000000000000000000000000000000
        Function: multicall(bytes[] data)

        [0] MethodID: 0xac9650d8
            [0]:  0000000000000000000000000000000000000000000000000000000000000020
            [1]:  0000000000000000000000000000000000000000000000000000000000000002
            [2]:  0000000000000000000000000000000000000000000000000000000000000040
            [3]:  00000000000000000000000000000000000000000000000000000000000001e0
            [4]:  0000000000000000000000000000000000000000000000000000000000000164
            [5]:  88316456000000000000000000000000c011a73ee8576fb46f5e1c5751ca3b9f
            [6]:  e0af2a6f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead908
            [7]:  3c756cc200000000000000000000000000000000000000000000000000000000
            [8]:  00002710ffffffffffffffffffffffffffffffffffffffffffffffffffffffff
            [9]:  fffee530ffffffffffffffffffffffffffffffffffffffffffffffffffffffff
            [10]: ffff1b1800000000000000000000000000000000000000000000000001634578
            [11]: 5d89fd6800000000000000000000000000000000000000000000000000007f73
            [12]: eca3063a000000000000000000000000000000000000000000000000016042b5
            [13]: 30ddaec600000000000000000000000000000000000000000000000000007e59
            [14]: f044bada000000000000000000000000f847e9d51989033b691b8be943f8e9e2
            [15]: 68f99b9e00000000000000000000000000000000000000000000000000000000
            [16]: 6377347700000000000000000000000000000000000000000000000000000000
            [17]: 0000000000000000000000000000000000000000000000000000000000000004
            [18]: 12210e8a00000000000000000000000000000000000000000000000000000000


        [1] MethodID: 0xac9650d8
            [00] 0000000000000000000000000000000000000000000000000000000000000020 // offset of array_1 (1 line down)
            [01] 0000000000000000000000000000000000000000000000000000000000000002 // length of array_1
            [02] 0000000000000000000000000000000000000000000000000000000000000040 // offset of array_2 (2 lines down)
            [03] 00000000000000000000000000000000000000000000000000000000000001e0 // 480 - everything from [04..17]

            [04] 0000000000000000000000000000000000000000000000000000000000000164 // length of array2 356

            [05] 883164560000000000000000c011a73ee8576fb46f5e1c5751ca3b9fe0af2a6f // 32
            [06] 000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2 // 64
            [07] 0000000000000000000000000000000000000000000000000000000000002710 // 96
            [08] fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffee530 // 128
            [09] ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1b18 // 160
            [10] 000000000000000000000000000000000000000000000000016345785d89fd68 // 192
            [11] 00000000000000000000000000000000000000000000000000007f73eca3063a // 224
            [12] 000000000000000000000000000000000000000000000000016042b530ddaec6 // 256
            [13] 00000000000000000000000000000000000000000000000000007e59f044bada // 288
            [14] 000000000000000000000000f847e9d51989033b691b8be943f8e9e268f99b9e // 320
            [15] 0000000000000000000000000000000000000000000000000000000063773477 // 352

            [16] 0000000000000000000000000000000000000000000000000000000000000000 // indication of next
            [17] 0000000000000000000000000000000000000000000000000000000000000004 // length of 4 (next function)

            [18] 12210e8a00000000000000000000000000000000000000000000000000000000 //
    */
    #[test]
    #[ignore]
    fn test_parse_multicall_2_step() {
        let calldata = "0xac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000016488316456000000000000000000000000c011a73ee8576fb46f5e1c5751ca3b9fe0af2a6f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000002710fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffee530ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1b18000000000000000000000000000000000000000000000000016345785d89fd6800000000000000000000000000000000000000000000000000007f73eca3063a000000000000000000000000000000000000000000000000016042b530ddaec600000000000000000000000000000000000000000000000000007e59f044bada000000000000000000000000f847e9d51989033b691b8be943f8e9e268f99b9e000000000000000000000000000000000000000000000000000000006377347700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000412210e8a00000000000000000000000000000000000000000000000000000000";
        println!(
            "\nCalldata char len: {}\nBytes: {}",
            calldata.len(),
            calldata.len() / 64 * 32
        );
        let _calldata = Calldata::new(calldata);
    }

    /*
        Convert the calldata [0]'s etherscan decoded to the following [1]:

        Tx: https://etherscan.io/tx/0x31a45e8893f0cc7de009da5546539f703ed725d076ccdf73d307df5caa8c72b3
        Calldata: 0xac9650d8000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000008413ead56200000000000000000000000061fe7a5257b963f231e1ef6e22cb3b4c6e28c531000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000002710000000000000000000000000000000000000000000831162ce86bc88052f80fd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001648831645600000000000000000000000061fe7a5257b963f231e1ef6e22cb3b4c6e28c531000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000002710fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffaf178000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e3bdc25349196582d720000000000000000000000000000000000000000000000000c249fdd32778000000000000000000000000000000000000000000000002e1e525c2ef9dcec50c53000000000000000000000000000000000000000000000000c1cd7c9adfb0d9dc000000000000000000000000ed6c2cb9bf89a2d290e59025837454bf1f144c5000000000000000000000000000000000000000000000000000000000635ce8bf00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000412210e8a00000000000000000000000000000000000000000000000000000000
        Function: multicall(bytes[] data)

        [0] MethodID: 0xac9650d8
            [0]:  0000000000000000000000000000000000000000000000000000000000000020
            [1]:  0000000000000000000000000000000000000000000000000000000000000003
            [2]:  0000000000000000000000000000000000000000000000000000000000000060
            [3]:  0000000000000000000000000000000000000000000000000000000000000120
            [4]:  00000000000000000000000000000000000000000000000000000000000002c0
            [5]:  0000000000000000000000000000000000000000000000000000000000000084
            [6]:  13ead56200000000000000000000000061fe7a5257b963f231e1ef6e22cb3b4c
            [7]:  6e28c531000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead908
            [8]:  3c756cc200000000000000000000000000000000000000000000000000000000
            [9]:  00002710000000000000000000000000000000000000000000831162ce86bc88
            [10]: 052f80fd00000000000000000000000000000000000000000000000000000000
            [11]: 0000000000000000000000000000000000000000000000000000000000000164
            [12]: 8831645600000000000000000000000061fe7a5257b963f231e1ef6e22cb3b4c
            [13]: 6e28c531000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead908
            [14]: 3c756cc200000000000000000000000000000000000000000000000000000000
            [15]: 00002710ffffffffffffffffffffffffffffffffffffffffffffffffffffffff
            [16]: fffaf17800000000000000000000000000000000000000000000000000000000
            [17]: 0000000000000000000000000000000000000000000000000002e3bdc2534919
            [18]: 6582d720000000000000000000000000000000000000000000000000c249fdd3
            [19]: 2778000000000000000000000000000000000000000000000002e1e525c2ef9d
            [20]: cec50c53000000000000000000000000000000000000000000000000c1cd7c9a
            [21]: dfb0d9dc000000000000000000000000ed6c2cb9bf89a2d290e59025837454bf
            [22]: 1f144c5000000000000000000000000000000000000000000000000000000000
            [23]: 635ce8bf00000000000000000000000000000000000000000000000000000000
            [24]: 0000000000000000000000000000000000000000000000000000000000000004
            [25]: 12210e8a00000000000000000000000000000000000000000000000000000000

        [1] MethodID: 0xac9650d8
            0000000000000000000000000000000000000000000000000000000000000020 // offset array_1
            0000000000000000000000000000000000000000000000000000000000000003 // length array_1
            0000000000000000000000000000000000000000000000000000000000000060 // offset array_1A (96/32=3)
            0000000000000000000000000000000000000000000000000000000000000120 // offset array_1B (288/32=9)
            00000000000000000000000000000000000000000000000000000000000002c0 // offset array_1C (704/32=22)

            0000000000000000000000000000000000000000000000000000000000000084 // length array_1A (132 (inc. selector))

            13ead562
            00000000000000000000000061fe7a5257b963f231e1ef6e22cb3b4c6e28c531 // 32
            000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2 // 64
            0000000000000000000000000000000000000000000000000000000000002710 // 96
            000000000000000000000000000000000000000000831162ce86bc88052f80fd // 128 (+ selector (4) = 132)

            0000000000000000000000000000000000000000000000000000000000000000 // indication of next
            00000000000000000000000000000000000000000000000000000164         // length of 356 (next function)

            88316456
            00000000000000000000000061fe7a5257b963f231e1ef6e22cb3b4c6e28c531 // 32
            000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2 // 64
            0000000000000000000000000000000000000000000000000000000000002710 // 96
            fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffaf178 // 128
            0000000000000000000000000000000000000000000000000000000000000000 // 160
            00000000000000000000000000000000000000000002e3bdc25349196582d720 // 192
            000000000000000000000000000000000000000000000000c249fdd327780000 // 224
            00000000000000000000000000000000000000000002e1e525c2ef9dcec50c53 // 256
            000000000000000000000000000000000000000000000000c1cd7c9adfb0d9dc // 288
            000000000000000000000000ed6c2cb9bf89a2d290e59025837454bf1f144c50 // 320
            00000000000000000000000000000000000000000000000000000000635ce8bf // 352 (+ selector = 356)

            0000000000000000000000000000000000000000000000000000000000000000 // indication of next
            00000000000000000000000000000000000000000000000000000004         // length of 4 (next function)

            12210e8a00000000000000000000000000000000000000000000000000000000 // 4
    */
    #[test]
    #[ignore]
    fn test_parse_multicall_3_step() {
        let calldata = "0xac9650d8000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000008413ead56200000000000000000000000061fe7a5257b963f231e1ef6e22cb3b4c6e28c531000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000002710000000000000000000000000000000000000000000831162ce86bc88052f80fd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001648831645600000000000000000000000061fe7a5257b963f231e1ef6e22cb3b4c6e28c531000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000002710fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffaf178000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e3bdc25349196582d720000000000000000000000000000000000000000000000000c249fdd32778000000000000000000000000000000000000000000000002e1e525c2ef9dcec50c53000000000000000000000000000000000000000000000000c1cd7c9adfb0d9dc000000000000000000000000ed6c2cb9bf89a2d290e59025837454bf1f144c5000000000000000000000000000000000000000000000000000000000635ce8bf00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000412210e8a00000000000000000000000000000000000000000000000000000000";
        println!(
            "\nCalldata char len: {}\nBytes: {}",
            calldata.len(),
            calldata.len() / 64 * 32
        );
        let _calldata = Calldata::new(calldata);
    }

    /*

        Tx: https://testnet.ftmscan.com/tx/0xa0801171ed2811082946ff7ff57e9470f98dcf5e64254bafd1d08ca959a051b7
        Calldata: 0xcf97008600000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000003313233000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000023435000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000436313334000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000161000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016300000000000000000000000000000000000000000000000000000000000000
        Function: embed(string[][] strings)

        MethodID: 0xcf970086
        [0]:  0000000000000000000000000000000000000000000000000000000000000020
        [1]:  0000000000000000000000000000000000000000000000000000000000000002
        [2]:  0000000000000000000000000000000000000000000000000000000000000040
        [3]:  0000000000000000000000000000000000000000000000000000000000000180
        [4]:  0000000000000000000000000000000000000000000000000000000000000003
        [5]:  0000000000000000000000000000000000000000000000000000000000000060
        [6]:  00000000000000000000000000000000000000000000000000000000000000a0
        [7]:  00000000000000000000000000000000000000000000000000000000000000e0
        [8]:  0000000000000000000000000000000000000000000000000000000000000003
        [9]:  3132330000000000000000000000000000000000000000000000000000000000
        [10]: 0000000000000000000000000000000000000000000000000000000000000002
        [11]: 3435000000000000000000000000000000000000000000000000000000000000
        [12]: 0000000000000000000000000000000000000000000000000000000000000004
        [13]: 3631333400000000000000000000000000000000000000000000000000000000
        [14]: 0000000000000000000000000000000000000000000000000000000000000003
        [15]: 0000000000000000000000000000000000000000000000000000000000000060
        [16]: 00000000000000000000000000000000000000000000000000000000000000a0
        [17]: 00000000000000000000000000000000000000000000000000000000000000e0
        [18]: 0000000000000000000000000000000000000000000000000000000000000001
        [19]: 6100000000000000000000000000000000000000000000000000000000000000
        [20]: 0000000000000000000000000000000000000000000000000000000000000001
        [21]: 6200000000000000000000000000000000000000000000000000000000000000
        [22]: 0000000000000000000000000000000000000000000000000000000000000001
        [23]: 6300000000000000000000000000000000000000000000000000000000000000

        TODO...UNFINISHED TEST
    */
    #[test]
    #[ignore]
    fn test_parse_nested_strings() {
        let calldata = "0xcf97008600000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000003313233000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000023435000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000436313334000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000161000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016300000000000000000000000000000000000000000000000000000000000000";
        println!(
            "\nCalldata char len: {}\nBytes: {}",
            calldata.len(),
            calldata.len() / 64 * 32
        );
        let _calldata = Calldata::new(calldata);
    }

    // Function: multicall(uint256 deadline,bytes[] data)
    // MethodID: 0x5ae401dc
    // [0]:  00000000000000000000000000000000000000000000000000000000638292b3
    // [1]:  0000000000000000000000000000000000000000000000000000000000000040
    // [2]:  0000000000000000000000000000000000000000000000000000000000000002
    // [3]:  0000000000000000000000000000000000000000000000000000000000000040
    // [4]:  0000000000000000000000000000000000000000000000000000000000000140
    // [5]:  00000000000000000000000000000000000000000000000000000000000000c4
    // [6]:  4659a4940000000000000000000000006b175474e89094c44da98b954eedeac4
    // [7]:  95271d0f00000000000000000000000000000000000000000000000000000000
    // [8]:  0000000100000000000000000000000000000000000000000000000000000000
    // [9]:  638296c700000000000000000000000000000000000000000000000000000000
    // [10]: 0000001c8892b2afb729fb079b7786393f3884f1d7317f18e9692bf4e8db90cf
    // [11]: 97f5854967048010f45d896e0c465dad3952be95afce410d0769c4014c827c20
    // [12]: f0cc525d00000000000000000000000000000000000000000000000000000000
    // [13]: 00000000000000000000000000000000000000000000000000000000000000e4
    // [14]: 04e45aaf0000000000000000000000006b175474e89094c44da98b954eedeac4
    // [15]: 95271d0f000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce
    // [16]: 3606eb4800000000000000000000000000000000000000000000000000000000
    // [17]: 000001f4000000000000000000000000a9af48f8cd3df47f913eefb032386f2d
    // [18]: 6debfb3500000000000000000000000000000000000000000000001be7653538
    // [19]: b68d564a00000000000000000000000000000000000000000000000000000000
    // [20]: 1e8297ae00000000000000000000000000000000000000000000000000000000
    // [21]: 0000000000000000000000000000000000000000000000000000000000000000
    /// TODO...UNFINISHED TEST
    /// https://etherscan.io/tx/0x1fb87cad877c5335bb1c756ae6ed338eb08e0acc9a086880967d4323537a1416
    #[test]
    fn test_uniswap_v3_router_2() {
        let calldata = "0x5ae401dc00000000000000000000000000000000000000000000000000000000638292b3000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000c44659a4940000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000638296c7000000000000000000000000000000000000000000000000000000000000001c8892b2afb729fb079b7786393f3884f1d7317f18e9692bf4e8db90cf97f5854967048010f45d896e0c465dad3952be95afce410d0769c4014c827c20f0cc525d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e404e45aaf0000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000a9af48f8cd3df47f913eefb032386f2d6debfb3500000000000000000000000000000000000000000000001be7653538b68d564a000000000000000000000000000000000000000000000000000000001e8297ae000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        println!(
            "\nCalldata char len: {}\nBytes: {}",
            calldata.len(),
            calldata.len() / 64 * 32
        );
        let _calldata = Calldata::new(calldata);
    }

    /*
    0x
    710a9f68
    00000000000000000000000000000000000000000000000000000000000005e4
    000000000000000000000000dc9c7a2bae15dd89271ae5701a6f4db147baa44c
    0000000000000000000000000000000000000000000000000000000000000060
    0000000000000000000000000000000000000000000000000000000000000124

    95723b1c
    0000000000000000000000006b175474e89094c44da98b954eedeac495271d0f
    000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2
    00000000000000000000000000000000000000000000000211d72bb3

    049586a7
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000006ee543b3be5a28a8f9
    00000000000000000000000000000000000000000000000016687535bce57786
    00000000000000000000000000000000000000000000000000000000

    */
    #[test]
    fn test_multicall_homora() {
        let calldata = "0x710a9f6800000000000000000000000000000000000000000000000000000000000005e4000000000000000000000000dc9c7a2bae15dd89271ae5701a6f4db147baa44c0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000012495723b1c0000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000211d72bb3049586a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006ee543b3be5a28a8f900000000000000000000000000000000000000000000000016687535bce5778600000000000000000000000000000000000000000000000000000000";
        println!(
            "\nCalldata char len: {}\nBytes: {}",
            calldata.len(),
            calldata.len() / 64 * 32
        );
        let _calldata = Calldata::new(calldata);
    }
}